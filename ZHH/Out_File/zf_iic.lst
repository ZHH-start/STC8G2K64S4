C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE ZF_IIC
OBJECT MODULE PLACED IN .\Out_File\zf_iic.obj
COMPILER INVOKED BY: C:\Keil_v5_C51\C51\BIN\C51.EXE ..\Libraries\seekfree_libraries\zf_iic.c LARGE OMF2 OPTIMIZE(8,SPEED
                    -) BROWSE INCDIR(..\Libraries\libraries;..\Libraries\seekfree_libraries;..\Libraries\seekfree_peripheral;..\USER;..\CODE)
                    - DEBUG PRINT(.\Out_File\zf_iic.lst) TABS(2) OBJECT(.\Out_File\zf_iic.obj)

line level    source

   1          /*********************************************************************************************************
             -************
   2           * COPYRIGHT NOTICE
   3           * Copyright (c) 2020,Öğ·É¿Æ¼¼
   4           * All rights reserved.
   5           * ¼¼ÊõÌÖÂÛQQÈº£ºÒ»Èº£º179029047(ÒÑÂú)  ¶şÈº£º244861897(ÒÑÂú)  ÈıÈº£º824575535
   6           *
   7           * ÒÔÏÂËùÓĞÄÚÈİ°æÈ¨¾ùÊôÖğ·É¿Æ¼¼ËùÓĞ£¬Î´¾­ÔÊĞí²»µÃÓÃÓÚÉÌÒµÓÃÍ¾£¬
   8           * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌĞò£¬ĞŞ¸ÄÄÚÈİÊ±±ØĞë±£ÁôÖğ·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷¡£
   9           *
  10           * @file          iic
  11           * @company       ³É¶¼Öğ·É¿Æ¼¼ÓĞÏŞ¹«Ë¾
  12           * @author        Öğ·É¿Æ¼¼(QQ790875685)
  13           * @version       ²é¿´docÄÚversionÎÄ¼ş °æ±¾ËµÃ÷
  14           * @Software    MDK FOR C51 V9.60
  15           * @Target core   STC8G2K64S4
  16           * @Taobao      https://seekfree.taobao.com/
  17           * @date          2020-4-14
  18           *********************************************************************************************************
             -***********/
  19          
  20          #include "zf_iic.h"
  21          
  22          
  23          
  24          //--------------------------------------------------------------------------------------------------------
             ------------
  25          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
  26          //  @param      NULL              
  27          //  @return     void
  28          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
  29          //--------------------------------------------------------------------------------------------------------
             ------------
  30          void iic_delay_us(uint16 x) //33.1776Mhz
  31          {
  32   1          uint8 i;
  33   1          while(x--)
  34   1          {
  35   2          i = 9;
  36   2          while (--i);
  37   2          }
  38   1      }
  39          
  40          
  41          //--------------------------------------------------------------------------------------------------------
             ------------
  42          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
  43          //  @param      NULL              
  44          //  @return     void
  45          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
  46          //--------------------------------------------------------------------------------------------------------
             ------------
  47          uint8 wait(void)
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 2   

  48          {
  49   1          uint16 count = 0;
  50   1          uint8 ret = IIC_SEND_OK;
  51   1          while (!(I2CMSST & 0x40))
  52   1          {
  53   2              iic_delay_us(1);
  54   2              if(count++ >= 30)//µÈ´ı³¬¹ı30us£¬ÔòÍË³öµÈ´ı¡£
  55   2              {
  56   3                  ret = IIC_SEND_FAIL;
  57   3                  break;
  58   3              }
  59   2          }
  60   1          I2CMSST &= ~0x40;
  61   1          return ret;
  62   1      }
  63          
  64          //--------------------------------------------------------------------------------------------------------
             ------------
  65          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
  66          //  @param      NULL
  67          //  @return     void
  68          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
  69          //--------------------------------------------------------------------------------------------------------
             ------------
  70          uint8 start(void)
  71          {
  72   1          uint8 ret;
  73   1          I2CMSCR = 0x01;                             //·¢ËÍstartÃüÁî
  74   1          ret = wait();
  75   1          return ret;
  76   1      }
  77          
  78          //--------------------------------------------------------------------------------------------------------
             ------------
  79          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
  80          //  @param      NULL              
  81          //  @return     void
  82          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
  83          //--------------------------------------------------------------------------------------------------------
             ------------
  84          uint8 send_data(char dat)
  85          {
  86   1          uint8 ret;
  87   1          I2CTXD = dat;                               //Ğ´Êı¾İµ½Êı¾İ»º³åÇø
  88   1          I2CMSCR = 0x02;                             //·¢ËÍSENDÃüÁî
  89   1          ret = wait();
  90   1          return ret;
  91   1      }
  92          
  93          //--------------------------------------------------------------------------------------------------------
             ------------
  94          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
  95          //  @param      NULL              
  96          //  @return     void
  97          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
  98          //--------------------------------------------------------------------------------------------------------
             ------------
  99          uint8 recv_ack(void)
 100          {
 101   1          uint8 ret;
 102   1          I2CMSCR = 0x03;                             //·¢ËÍ¶ÁACKÃüÁî
 103   1          ret = wait();
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 3   

 104   1          return ret;
 105   1      }
 106          
 107          //--------------------------------------------------------------------------------------------------------
             ------------
 108          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
 109          //  @param      NULL              
 110          //  @return     void
 111          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
 112          //--------------------------------------------------------------------------------------------------------
             ------------
 113          char recv_data(void)              //½ÓÊÕÊı¾İ
 114          {
 115   1          I2CMSCR = 0x04;                             //·¢ËÍRECVÃüÁî
 116   1          wait();
 117   1          return I2CRXD;
 118   1      }
 119          
 120          //--------------------------------------------------------------------------------------------------------
             ------------
 121          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
 122          //  @param      NULL              
 123          //  @return     void
 124          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
 125          //--------------------------------------------------------------------------------------------------------
             ------------
 126          uint8 send_ack(void)
 127          {
 128   1        uint8 ret;
 129   1          I2CMSST = 0x00;                             //ÉèÖÃACKĞÅºÅ
 130   1          I2CMSCR = 0x05;                             //·¢ËÍACKÃüÁî
 131   1          ret = wait();
 132   1          return ret;
 133   1      }
 134          
 135          //--------------------------------------------------------------------------------------------------------
             ------------
 136          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
 137          //  @param      NULL              
 138          //  @return     void
 139          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
 140          //--------------------------------------------------------------------------------------------------------
             ------------
 141          void send_nak(void)
 142          {
 143   1          I2CMSST = 0x01;                             //ÉèÖÃNAKĞÅºÅ
 144   1          I2CMSCR = 0x05;                             //·¢ËÍACKÃüÁî
 145   1          wait();
 146   1      }
 147          
 148          //--------------------------------------------------------------------------------------------------------
             ------------
 149          //  @brief      ÄÚ²¿Ê¹ÓÃÓÃ»§ÎŞĞè¹ØĞÄ
 150          //  @param      NULL              
 151          //  @return     void
 152          //  Sample usage:               ÎŞĞèÓÃ»§µ÷ÓÃ£¬ÓÃ»§ÇëÊ¹ÓÃhÎÄ¼şÖĞµÄºê¶¨Òå
 153          //--------------------------------------------------------------------------------------------------------
             ------------
 154          uint8 stop(void)
 155          {
 156   1          uint8 ret;
 157   1          I2CMSCR = 0x06;                             //·¢ËÍstopÃüÁî
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 4   

 158   1          ret = wait();
 159   1          return ret;
 160   1      }
 161          
 162          //--------------------------------------------------------------------------------------------------------
             ------------
 163          //  @brief      Ó²¼şIIC³õÊ¼»¯
 164          //  @param      iic_n           Ñ¡ÔñIICÄ£¿é
 165          //  @param      wait_time       I2C×ÜÏßËÙ¶È£¨µÈ´ıÊ±ÖÓÊı£©¿ØÖÆ: ËÙ¶ÈÉèÖÃÎªµÈ´ıwait_time*2+1¸öÊ±ÖÓ
 166          //  @return     void
 167          //  Sample usage:              
 168          //--------------------------------------------------------------------------------------------------------
             ------------
 169          void iic_init(IICN_enum iic_n, IIC_PIN_enum scl_pin, IIC_PIN_enum sda_pin, uint32 wait_time)
 170          {
 171   1        scl_pin = scl_pin;
 172   1        sda_pin = sda_pin;
 173   1          P_SW2 &= ~(0x03<<4);
 174   1          P_SW2 |= 1<<7;  //½«EAXFR¼Ä´æÆ÷ÖÃ1£¬ÕâÑù²ÅÄÜÊ¹ÓÃÌØÊâ¹¦ÄÜ¼Ä´æÆ÷ÎªÀ©Õ¹SFR£¬·ÃÎÊÂß¼­µØÖ·Î»ÓÚ XDATA ÇøÓò
 175   1          switch(iic_n)
 176   1          {
 177   2          case IIC_1:
 178   2              P_SW2 |= (0x00<<4); //SCL:P1.5  SDA:P1.4
 179   2              break;
 180   2          case IIC_2:
 181   2              P_SW2 |= (0x01<<4); //SCL:P2.5  SDA:P2.4
 182   2              break;
 183   2          case IIC_3:
 184   2              P_SW2 |= (0x02<<4); //SCL:P7.7  SDA:P7.6
 185   2              break;
 186   2          case IIC_4:
 187   2              P_SW2 |= (0x03<<4); //SCL:P3.2  SDA:P3.3
 188   2              break;
 189   2          }
 190   1      
 191   1          I2CCFG |= 1<<6;   //Ö÷»úÄ£Ê½
 192   1          I2CCFG |= 1<<7;   //Ê¹ÄÜIIC
 193   1          I2CCFG |= wait_time;//ËÙ¶ÈÉèÖÃÎªµÈ´ıwait_time*2+1¸öÊ±ÖÓ
 194   1          I2CMSST = 0x00;   //Ö÷»ú×´Ì¬¼Ä´æÆ÷
 195   1      }
 196          
 197          //--------------------------------------------------------------------------------------------------------
             ------------
 198          //  @brief      Ğ´ÈëÒ»¸ö×Ö½ÚÊı¾İµ½I2CÉè±¸Ö¸¶¨¼Ä´æÆ÷µØÖ·
 199          //  @param      iic_n       IICÄ£¿é(IIC_1,IIC_2,IIC_3,IIC_0)
 200          //  @param      slaveid     ´Ó»úµØÖ·(7Î»µØÖ·)
 201          //  @param      reg         ´Ó»ú¼Ä´æÆ÷µØÖ·
 202          //  @param      dat         ĞèÒª·¢ËÍµÄÊı¾İ
 203          //  @return                 ·µ»ØµÄ×´Ì¬Öµ 0£º³É¹¦  1£ºÊ§°Ü
 204          //  @since      v2.0
 205          //  Sample usage:         iic_write_reg(0x2D, 0x50,2);     //Ğ´ÈëÊı¾İ2µ½0x50µØÖ·£¬´Ó»úµØÖ·Îª0x2D
 206          //--------------------------------------------------------------------------------------------------------
             ------------
 207          uint8 iic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
 208          {
 209   1          if(start() != IIC_SEND_OK)
 210   1              return IIC_SEND_FAIL;
 211   1      //    if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
 212   1      //        return IIC_SEND_FAIL;
 213   1          if(send_data(dev_add) != IIC_SEND_OK)
 214   1              return IIC_SEND_FAIL;
 215   1          if(recv_ack() != IIC_SEND_OK)
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 5   

 216   1              return IIC_SEND_FAIL;
 217   1          if(send_data(reg) != IIC_SEND_OK)
 218   1              return IIC_SEND_FAIL;
 219   1          if(recv_ack() != IIC_SEND_OK)
 220   1              return IIC_SEND_FAIL;
 221   1          if(send_data(dat) != IIC_SEND_OK)
 222   1              return IIC_SEND_FAIL;
 223   1          if(recv_ack() != IIC_SEND_OK)
 224   1              return IIC_SEND_FAIL;
 225   1          if(stop() != IIC_SEND_OK)
 226   1              return IIC_SEND_FAIL;
 227   1      
 228   1          return IIC_SEND_OK;
 229   1      }
 230          //  Á¬ĞøĞ´Êı¾İ
 231          char iicWriteDate(unsigned char devAddr ,unsigned char regAddr , unsigned char *p_dat , int len )
 232          {
 233   1          start();                                    //·¢ËÍÆğÊ¼ÃüÁî
 234   1          send_data(devAddr);                          //·¢ËÍÉè±¸µØÖ·+Ğ´ÃüÁî
 235   1          recv_ack();
 236   1          send_data(regAddr);                          //·¢ËÍ´æ´¢µØÖ·¸ß×Ö½Ú
 237   1          recv_ack();
 238   1          while(len --)
 239   1          {
 240   2            send_data(*p_dat ++);                             //Ğ´²âÊÔÊı¾İ1
 241   2            recv_ack();
 242   2          }
 243   1          stop(); 
 244   1          return 0;   
 245   1      }
 246          
 247          
 248          //--------------------------------------------------------------------------------------------------------
             ------------
 249          //  @brief      ¶ÁÈ¡I2CÉè±¸Ö¸¶¨µØÖ·¼Ä´æÆ÷µÄÊı¾İ
 250          //  @param      iic_n        I2CÍ¨µÀºÅ¼°Òı½Å
 251          //  @param      dev_add     ´Ó»úµØÖ·(7Î»µØÖ·)
 252          //  @param      reg         ´Ó»ú¼Ä´æÆ÷µØÖ·
 253          //  @param      dat         Êı¾İµØÖ·
 254          //  @return                 ¶ÁÈ¡µÄ¼Ä´æÆ÷Öµ
 255          //  @since      v1.0
 256          //  Sample usage:         uint8 value = iic_read_reg(i2c0, 0x2D, 0x50);//¶ÁÈ¡0x50µØÖ·µÄÊı¾İ£¬´Ó»úµØÖ·Îª0x2D
 257          //--------------------------------------------------------------------------------------------------------
             ------------
 258          uint8 iic_read_reg(uint8 dev_add, uint8 reg, uint8 *dat)
 259          {
 260   1        if(start() != IIC_SEND_OK)
 261   1              return IIC_SEND_FAIL;
 262   1        
 263   1          if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
 264   1              return IIC_SEND_FAIL;
 265   1          if(recv_ack() != IIC_SEND_OK)
 266   1              return IIC_SEND_FAIL;
 267   1      
 268   1          if(send_data(reg) != IIC_SEND_OK)
 269   1              return IIC_SEND_FAIL;
 270   1          if(recv_ack() != IIC_SEND_OK)
 271   1              return IIC_SEND_FAIL;
 272   1        
 273   1        
 274   1      //   if(start() != IIC_SEND_OK)
 275   1      //        return IIC_SEND_FAIL;
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 6   

 276   1         
 277   1          if(send_data((dev_add<<1) | 0x01) != IIC_SEND_OK)
 278   1              return IIC_SEND_FAIL;
 279   1        
 280   1          if(recv_ack() != IIC_SEND_OK)
 281   1              return IIC_SEND_FAIL;
 282   1        
 283   1      
 284   1          *dat = recv_data(); //¶ÁÈ¡Êı¾İ
 285   1      
 286   1        
 287   1          if(send_ack() != IIC_SEND_OK)
 288   1              return IIC_SEND_FAIL;
 289   1        
 290   1          if(stop() != IIC_SEND_OK)
 291   1              return IIC_SEND_FAIL;
 292   1        
 293   1          return IIC_SEND_OK;
 294   1      }
 295          
 296          //--------------------------------------------------------------------------------------------------------
             ------------
 297          //  @brief      ¶ÁÈ¡I2CÉè±¸Ö¸¶¨µØÖ·¼Ä´æÆ÷µÄÊı¾İ
 298          //  @param      iic_n       I2CÍ¨µÀºÅ¼°Òı½Å
 299          //  @param      dev_add     ´Ó»úµØÖ·(7Î»µØÖ·)
 300          //  @param      reg         ´Ó»ú¼Ä´æÆ÷µØÖ·
 301          //  @param      dat         ¶ÁÈ¡µÄÊı¾İ´æ´¢µÄµØÖ·
 302          //  @param      num         ¶ÁÈ¡×Ö½ÚÊı
 303          //  @return     void
 304          //  @since      v1.0
 305          //  Sample usage:         uint8 value = i2c_read_reg(i2c0, 0x2D, 0x50, 10, buf);//¶ÁÈ¡0x50µØÖ·µÄÊı¾İ£¬´Ó»úµ
             -ØÖ·Îª0x2D¿ªÊ¼µÄ10¸ö×Ö½Ú
 306          //--------------------------------------------------------------------------------------------------------
             ------------
 307          uint8 iic_read_reg_bytes(uint8 dev_add, uint8 reg
 308                      , uint8 *dat, uint8 num)
 309          {
 310   1      
 311   1        if(start() != IIC_SEND_OK)
 312   1              return IIC_SEND_FAIL;
 313   1        
 314   1          if(send_data((dev_add<<1) | 0x00) != IIC_SEND_OK)
 315   1              return IIC_SEND_FAIL;
 316   1          if(recv_ack() != IIC_SEND_OK)
 317   1              return IIC_SEND_FAIL;
 318   1        
 319   1          if(send_data(reg) != IIC_SEND_OK)
 320   1              return IIC_SEND_FAIL;
 321   1          if(recv_ack() != IIC_SEND_OK)
 322   1              return IIC_SEND_FAIL;
 323   1      
 324   1        if(send_data((dev_add<<1) | 0x01) != IIC_SEND_OK)
 325   1          return IIC_SEND_FAIL;
 326   1        if(recv_ack() != IIC_SEND_OK)
 327   1          return IIC_SEND_FAIL;
 328   1      
 329   1          while(--num)
 330   1          {
 331   2              *dat = recv_data(); //¶ÁÈ¡Êı¾İ
 332   2          if(send_ack() != IIC_SEND_OK)
 333   2          {
 334   3            return IIC_SEND_FAIL;
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 7   

 335   3          }
 336   2              dat++;
 337   2          }
 338   1        
 339   1        *dat = recv_data();
 340   1        
 341   1        if(send_ack() != IIC_SEND_OK)
 342   1          return IIC_SEND_FAIL;
 343   1        
 344   1        if(stop() != IIC_SEND_OK)
 345   1          return IIC_SEND_FAIL;
 346   1        
 347   1        return IIC_SEND_OK;
 348   1      }
 349          
 350          
 351          //--------------------------------------------------------------------------------------------------------
             ------------
 352          //  @brief      Ó²¼şIICÒı½ÅÇĞ»»º¯Êı
 353          //  @param      iic_n         I2CÍ¨µÀºÅ¼°Òı½Å
 354          //  @param      scl_pin         Ñ¡ÔñSCLÒı½Å
 355          //  @param      sda_pin         Ñ¡ÔñSDAÒı½Å
 356          //  Sample usage:       
 357          //--------------------------------------------------------------------------------------------------------
             ------------
 358          void iic_change_pin(IICN_enum iic_n,IIC_PIN_enum scl_pin,IIC_PIN_enum sda_pin)
 359          {
 360   1        scl_pin = scl_pin;
 361   1        sda_pin = sda_pin;
 362   1          P_SW2 |= 1<<7;  //½«EAXFR¼Ä´æÆ÷ÖÃ1£¬ÕâÑù²ÅÄÜÊ¹ÓÃÌØÊâ¹¦ÄÜ¼Ä´æÆ÷ÎªÀ©Õ¹SFR£¬·ÃÎÊÂß¼­µØÖ·Î»ÓÚ XDATA ÇøÓò
 363   1        
 364   1        P_SW2 &= ~(0x03<<4);  //Çå³ıÒı½ÅÇĞ»»Î»
 365   1          switch(iic_n) 
 366   1          {
 367   2          case IIC_1:
 368   2              P_SW2 |= (0x00<<4); //SCL:P1.5  SDA:P1.4
 369   2              break;
 370   2          case IIC_2:
 371   2              P_SW2 |= (0x01<<4); //SCL:P2.5  SDA:P2.4
 372   2              break;
 373   2          case IIC_3:
 374   2              P_SW2 |= (0x02<<4); //Ã»ÓĞ¸Ã×éÒı½Å
 375   2              break;
 376   2          case IIC_4:
 377   2              P_SW2 |= (0x03<<4); //SCL:P3.2  SDA:P3.3
 378   2              break;
 379   2          }
 380   1        
 381   1        P_SW2 &= ~(1<<7);
 382   1      
 383   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    706    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----      28
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   ZF_IIC                                                            12/08/2023 20:31:20 PAGE 8   

   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
